<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Đánh Giá Tình Yêu 💕</title>
  <link rel="stylesheet" href="styles/admin.css" />
  </head>

  <body>
    <div class="header-container">
      <a href="index.html" class="back-link">💝 Về trang đánh giá</a>
      <h1>💕 Kho kỷ niệm tình yêu của chúng mình 💕</h1>
      
      <div class="stats-bar" id="statsBar"></div>

      <div class="control-panel">
        <div class="control-group">
          <label for="sortSelect">🔄 Sắp xếp:</label>
          <select id="sortSelect" onchange="fetchRatings()">
            <option value="desc">✨ Mới nhất</option>
            <option value="asc">⏰ Cũ nhất</option>
          </select>
        </div>

        <div class="control-group">
          <label for="starFilter">⭐ Lọc theo sao:</label>
          <select id="starFilter" onchange="fetchRatings()">
            <option value="">💖 Tất cả</option>
            <option value="5">⭐⭐⭐⭐⭐ 5 sao</option>
            <option value="4">⭐⭐⭐⭐ 4 sao</option>
            <option value="3">⭐⭐⭐ 3 sao</option>
            <option value="2">⭐⭐ 2 sao</option>
            <option value="1">⭐ 1 sao</option>
          </select>
        </div>

        <div class="control-group">
          <label class="checkbox-label">
            <input type="checkbox" id="favoriteFilter" onchange="fetchRatings()" />
            <span>💗 Chỉ yêu thích</span>
          </label>
        </div>

        <button class="toggle-view-btn" onclick="toggleViewMode()">
          🔄 Chuyển sang bảng
        </button>
      </div>
    </div>

    <div class="main-container">
      <div id="ratingList" class="container grid-view"></div>
      <button class="bulk-delete-btn" onclick="deleteSelectedRatings()">
        Xoá các kỷ niệm đã chọn
      </button>
    </div>

    <div id="imgModal" class="modal" onclick="closeModal()">
      <span class="close">&times;</span>
      <img class="modal-content" id="modalImg" onclick="event.stopPropagation()" />
      <a id="downloadLink" class="download-btn" download onclick="event.stopPropagation()">⬇️ Tải ảnh xinh về máy nè</a>
    </div>

    <script>
      const API_URL = "https://couple-date-rating-2.onrender.com";
      let isListView = false;
      let allRatings = [];

      function updateStats(data) {
        const total = data.length;
        const favorites = data.filter(r => r.is_favorite).length;
        const avgRating = total > 0 
          ? (data.reduce((sum, r) => sum + r.rating, 0) / total).toFixed(1)
          : 0;

        document.getElementById('statsBar').innerHTML = `
          <div class="stat-card">
            <span class="stat-number">${total}</span>
            <span class="stat-label">💕 Tổng kỷ niệm</span>
          </div>
          <div class="stat-card">
            <span class="stat-number">${favorites}</span>
            <span class="stat-label">💖 Yêu thích nhất</span>
          </div>
          <div class="stat-card">
            <span class="stat-number">${avgRating} ⭐</span>
            <span class="stat-label">🌟 Điểm trung bình</span>
          </div>
        `;
      }

      function fetchRatings() {
        const sortOrder = document.getElementById("sortSelect").value;
        const starFilter = document.getElementById("starFilter").value;
        const onlyFavorite = document.getElementById("favoriteFilter").checked;
        const container = document.getElementById("ratingList");

        let url = `${API_URL}/api/ratings?order=${sortOrder}`;
        if (starFilter) url += `&star=${starFilter}`;
        if (onlyFavorite) url += `&favorite=true`;

        fetch(url)
          .then((res) => res.json())
          .then((data) => {
            allRatings = data;
            updateStats(data);

            if (data.length === 0) {
              container.innerHTML = `
                <div class="empty-state">
                  <div class="empty-state-icon">💝</div>
                  <div class="empty-state-text">Chưa có kỷ niệm nào được lưu lại nè~ 🥺</div>
                </div>
              `;
              return;
            }

            if (isListView) {
              container.className = "container list-view";
              container.innerHTML = `
                <table>
                  <thead>
                    <tr>
                      <th>💕 Chọn</th>
                      <th>📸 Ảnh</th>
                      <th>⭐ Sao</th>
                      <th>💭 Cảm xúc</th>
                      <th>📅 Ngày</th>
                      <th>💖 Yêu thích</th>
                      <th>🎯 Thao tác</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${data.map((item) => {
                      const safePhoto = item.photo && item.photo.startsWith("data:image/") ? item.photo : null;
                      return `
                        <tr>
                          <td><input type="checkbox" class="checkbox" data-id="${item.id}"></td>
                          <td>${safePhoto 
                            ? `<img src="${safePhoto}" class="table-img" onclick="openModal('${safePhoto}')">`
                            : '<span style="color: #ffb3d9;">💭 Không có ảnh</span>'
                          }</td>
                          <td><strong>⭐ ${item.rating}</strong></td>
                          <td style="max-width: 300px; text-align: left; color: #666;">${item.feeling}</td>
                          <td style="white-space: nowrap; color: #ff9ec4; font-weight: 600;">${new Date(item.created_at).toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" })}</td>
                          <td>
                            <button class="table-favorite-btn" onclick="toggleFavorite(${item.id}, ${item.is_favorite})">${item.is_favorite ? "💖" : "🤍"}</button>
                          </td>
                          <td>
                            <button class="table-delete-btn" onclick="deleteRating(${item.id})">🗑️ Xóa</button>
                          </td>
                        </tr>`;
                    }).join("")}
                  </tbody>
                </table>`;
            } else {
              container.className = "container grid-view";
              container.innerHTML = data.map((item) => {
                const safePhoto = item.photo && item.photo.startsWith("data:image/") ? item.photo : null;
                return `
                  <div class="memory-item">
                    <div class="memory-item-header">
                      <input type="checkbox" class="checkbox" data-id="${item.id}">
                      <span class="rating-badge">⭐ ${item.rating} sao</span>
                    </div>
                    <span class="date-badge">📅 ${new Date(item.created_at).toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" })}</span>
                    <div class="feeling-text">💭 ${item.feeling}</div>
                    ${safePhoto 
                      ? `<img src="${safePhoto}" onclick="openModal('${safePhoto}')" alt="Memory photo">`
                      : '<div class="no-image">📷 Chưa có ảnh kỷ niệm</div>'
                    }
                    <div class="button-group">
                      <button class="favorite-btn" onclick="toggleFavorite(${item.id}, ${item.is_favorite})">${item.is_favorite ? "💖 Đã yêu thích rồi nè" : "🤍 Thêm vào yêu thích"}</button>
                      <button class="delete-btn" onclick="deleteRating(${item.id})">🗑️ Xóa đi</button>
                    </div>
                  </div>`;
              }).join("");
            }
          })
          .catch(err => {
            console.error('Error:', err);
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">😢</div>
                <div class="empty-state-text">Ôi không! Không thể tải dữ liệu được 💔</div>
              </div>
            `;
          });
      }

      function deleteRating(id) {
        if (confirm("Bạn có chắc muốn xóa kỷ niệm này không? 🥺")) {
          fetch(`${API_URL}/api/ratings/${id}`, { method: "DELETE" })
            .then(() => fetchRatings());
        }
      }

      function deleteSelectedRatings() {
        const checkboxes = document.querySelectorAll(".checkbox:checked");
        if (!checkboxes.length) {
          alert("Chưa chọn kỷ niệm nào để xóa cả~ 💕");
          return;
        }
        if (!confirm(`Bạn có chắc muốn xóa ${checkboxes.length} kỷ niệm đã chọn không? 🥺💔`)) return;
        
        const ids = Array.from(checkboxes).map((cb) => cb.dataset.id);
        Promise.all(ids.map((id) => fetch(`${API_URL}/api/ratings/${id}`, { method: "DELETE" })))
          .then(() => fetchRatings());
      }

      function toggleFavorite(id, current) {
        fetch(`${API_URL}/api/ratings/${id}/favorite`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ is_favorite: !current }),
        }).then(() => fetchRatings());
      }

      function toggleViewMode() {
        isListView = !isListView;
        document.querySelector(".toggle-view-btn").textContent = isListView
          ? "🔄 Chuyển sang lưới"
          : "🔄 Chuyển sang bảng";
        fetchRatings();
      }

      function openModal(src) {
        const modal = document.getElementById("imgModal");
        const img = document.getElementById("modalImg");
        const link = document.getElementById("downloadLink");
        modal.style.display = "block";
        img.src = src;
        link.href = src;
      }

      function closeModal() {
        document.getElementById("imgModal").style.display = "none";
      }

      window.onclick = function(event) {
        const modal = document.getElementById("imgModal");
        if (event.target == modal) {
          closeModal();
        }
      }

      fetchRatings();
    </script>
  </body>
</html>