<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin - ÄÃ¡nh GiÃ¡ TÃ¬nh YÃªu ğŸ’Œ</title>
    <link rel="stylesheet" href="styles/style.css" />
    <a href="index.html">vá» trang Ä‘Ã¡nh giÃ¡</a>
    <style>
      .delete-btn {
        background-color: #ff4081;
        color: white;
        border: none;
        border-radius: 10px;
        padding: 5px 10px;
        margin-top: 10px;
        cursor: pointer;
      }
      .delete-btn:hover {
        background-color: #e60073;
      }
      .bulk-delete-btn {
        background-color: #ff1744;
        color: white;
        border: none;
        border-radius: 12px;
        padding: 8px 16px;
        margin: 20px auto;
        display: block;
        font-size: 16px;
        cursor: pointer;
      }
      .bulk-delete-btn:hover {
        background-color: #c4001d;
      }
      .checkbox {
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <h1 style="text-align: center; color: #ff4081">ğŸ“Š Quáº£n lÃ½ Ä‘Ã¡nh giÃ¡</h1>
    <div id="ratingList" class="container"></div>

    <button class="bulk-delete-btn" onclick="deleteSelectedRatings()">ğŸ—‘ï¸ XoÃ¡ cÃ¡c Ä‘Ã¡nh giÃ¡ Ä‘Ã£ chá»n</button>

    <script>
      const API_URL = "http://localhost:4000";
        const correctPassword = "05112005";
  const userInput = prompt("Vui lÃ²ng nháº­p máº­t kháº©u Ä‘á»ƒ vÃ o trang admin:");
  alert("ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i trang quáº£n lÃ½ Ä‘Ã¡nh giÃ¡! ğŸ’–");
  if (userInput !== correctPassword) {
    alert("Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p!");
    alert("Báº¡n sáº½ Ä‘Æ°á»£c chuyá»ƒn vá» trang chÃ­nh.");
    window.location.href = "index.html";
  }


      function fetchRatings() {
        fetch(`${API_URL}/api/ratings`)
          .then((res) => res.json())
          .then((data) => {
            const list = document.getElementById("ratingList");
            list.innerHTML = data
              .map((item) => {
                const safePhoto =
                  item.photo && item.photo.startsWith("data:image/")
                    ? item.photo
                    : null;
                    
                return `
                
          <div class="memory-item" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <input type="checkbox" class="checkbox" data-id="${item.id}">
            <strong>â­ ${item.rating}</strong> â€“ ${new Date().toLocaleString('vi-VN')}<br>
            <em>${item.feeling}</em><br>
            ${
              safePhoto
                ? `<img src="${safePhoto}" style="max-width: 200px; margin-top: 10px;" alt="Photo"><br>`
                : '<span style="color: gray;">(KhÃ´ng cÃ³ áº£nh)</span><br>'
            }
            <button class="delete-btn" onclick="deleteRating(${item.id})">ğŸ—‘ï¸ XÃ³a Ä‘Ã¡nh giÃ¡</button>
          </div>
        `;
              })
              .join("");
          })
          .catch((err) => {
            document.getElementById("ratingList").textContent =
              "Lá»—i táº£i Ä‘Ã¡nh giÃ¡.";
            console.error(err);
          });
      }

      function deleteRating(id) {
        if (confirm("Báº¡n cÃ³ cháº¯c muá»‘n xoÃ¡ Ä‘Ã¡nh giÃ¡ nÃ y khÃ´ng?")) {
          fetch(`${API_URL}/api/ratings/${id}`, {
            method: "DELETE",
          })
            .then((res) => res.json())
            .then((data) => {
              alert(data.message || "ÄÃ£ xÃ³a Ä‘Ã¡nh giÃ¡.");
              fetchRatings();
            })
            .catch((err) => {
              alert("Lá»—i khi xoÃ¡ Ä‘Ã¡nh giÃ¡.");
              console.error(err);
            });
        }
      }

      function deleteSelectedRatings() {
        const checkboxes = document.querySelectorAll('.checkbox:checked');
        if (checkboxes.length === 0) {
          alert("Vui lÃ²ng chá»n Ã­t nháº¥t má»™t Ä‘Ã¡nh giÃ¡ Ä‘á»ƒ xoÃ¡.");
          return;
        }

        if (!confirm(`Báº¡n cÃ³ cháº¯c muá»‘n xoÃ¡ ${checkboxes.length} Ä‘Ã¡nh giÃ¡ Ä‘Ã£ chá»n khÃ´ng?`)) return;

        const ids = Array.from(checkboxes).map(cb => cb.dataset.id);

        // XoÃ¡ tá»«ng Ä‘Ã¡nh giÃ¡ tuáº§n tá»± (hoáº·c cÃ³ thá»ƒ dÃ¹ng Promise.all Ä‘á»ƒ xoÃ¡ song song)
        Promise.all(
          ids.map(id =>
            fetch(`${API_URL}/api/ratings/${id}`, {
              method: "DELETE",
            }).then(res => res.json())
          )
        )
          .then(() => {
            alert(`ÄÃ£ xoÃ¡ ${ids.length} Ä‘Ã¡nh giÃ¡.`);
            fetchRatings();
          })
          .catch((err) => {
            alert("CÃ³ lá»—i xáº£y ra khi xoÃ¡ Ä‘Ã¡nh giÃ¡.");
            console.error(err);
          });
      }

      fetchRatings();
    </script>
  </body>
</html>
