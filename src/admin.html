<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - ÄÃ¡nh GiÃ¡ TÃ¬nh YÃªu ğŸ’•</title>
  <link rel="stylesheet" href="styles/admin.css" />
  </head>

  <body>
    <div class="header-container">
      <a href="index.html" class="back-link">ğŸ’ Vá» trang Ä‘Ã¡nh giÃ¡</a>
      <h1>ğŸ’• Kho ká»· niá»‡m tÃ¬nh yÃªu cá»§a chÃºng mÃ¬nh ğŸ’•</h1>
      
      <div class="stats-bar" id="statsBar"></div>

      <div class="control-panel">
        <div class="control-group">
          <label for="sortSelect">ğŸ”„ Sáº¯p xáº¿p:</label>
          <select id="sortSelect" onchange="fetchRatings()">
            <option value="desc">âœ¨ Má»›i nháº¥t</option>
            <option value="asc">â° CÅ© nháº¥t</option>
          </select>
        </div>

        <div class="control-group">
          <label for="starFilter">â­ Lá»c theo sao:</label>
          <select id="starFilter" onchange="fetchRatings()">
            <option value="">ğŸ’– Táº¥t cáº£</option>
            <option value="5">â­â­â­â­â­ 5 sao</option>
            <option value="4">â­â­â­â­ 4 sao</option>
            <option value="3">â­â­â­ 3 sao</option>
            <option value="2">â­â­ 2 sao</option>
            <option value="1">â­ 1 sao</option>
          </select>
        </div>

        <div class="control-group">
          <label class="checkbox-label">
            <input type="checkbox" id="favoriteFilter" onchange="fetchRatings()" />
            <span>ğŸ’— Chá»‰ yÃªu thÃ­ch</span>
          </label>
        </div>

        <button class="toggle-view-btn" onclick="toggleViewMode()">
          ğŸ”„ Chuyá»ƒn sang báº£ng
        </button>
      </div>
    </div>

    <div class="main-container">
      <div id="ratingList" class="container grid-view"></div>
      <button class="bulk-delete-btn" onclick="deleteSelectedRatings()">
        XoÃ¡ cÃ¡c ká»· niá»‡m Ä‘Ã£ chá»n
      </button>
    </div>

    <div id="imgModal" class="modal" onclick="closeModal()">
      <span class="close">&times;</span>
      <img class="modal-content" id="modalImg" onclick="event.stopPropagation()" />
      <a id="downloadLink" class="download-btn" download onclick="event.stopPropagation()">â¬‡ï¸ Táº£i áº£nh xinh vá» mÃ¡y nÃ¨</a>
    </div>

    <script>
      const API_URL = "https://couple-date-rating-2.onrender.com";
      let isListView = false;
      let allRatings = [];

      function updateStats(data) {
        const total = data.length;
        const favorites = data.filter(r => r.is_favorite).length;
        const avgRating = total > 0 
          ? (data.reduce((sum, r) => sum + r.rating, 0) / total).toFixed(1)
          : 0;

        document.getElementById('statsBar').innerHTML = `
          <div class="stat-card">
            <span class="stat-number">${total}</span>
            <span class="stat-label">ğŸ’• Tá»•ng ká»· niá»‡m</span>
          </div>
          <div class="stat-card">
            <span class="stat-number">${favorites}</span>
            <span class="stat-label">ğŸ’– YÃªu thÃ­ch nháº¥t</span>
          </div>
          <div class="stat-card">
            <span class="stat-number">${avgRating} â­</span>
            <span class="stat-label">ğŸŒŸ Äiá»ƒm trung bÃ¬nh</span>
          </div>
        `;
      }

      function fetchRatings() {
        const sortOrder = document.getElementById("sortSelect").value;
        const starFilter = document.getElementById("starFilter").value;
        const onlyFavorite = document.getElementById("favoriteFilter").checked;
        const container = document.getElementById("ratingList");

        let url = `${API_URL}/api/ratings?order=${sortOrder}`;
        if (starFilter) url += `&star=${starFilter}`;
        if (onlyFavorite) url += `&favorite=true`;

        fetch(url)
          .then((res) => res.json())
          .then((data) => {
            allRatings = data;
            updateStats(data);

            if (data.length === 0) {
              container.innerHTML = `
                <div class="empty-state">
                  <div class="empty-state-icon">ğŸ’</div>
                  <div class="empty-state-text">ChÆ°a cÃ³ ká»· niá»‡m nÃ o Ä‘Æ°á»£c lÆ°u láº¡i nÃ¨~ ğŸ¥º</div>
                </div>
              `;
              return;
            }

            if (isListView) {
              container.className = "container list-view";
              container.innerHTML = `
                <table>
                  <thead>
                    <tr>
                      <th>ğŸ’• Chá»n</th>
                      <th>ğŸ“¸ áº¢nh</th>
                      <th>â­ Sao</th>
                      <th>ğŸ’­ Cáº£m xÃºc</th>
                      <th>ğŸ“… NgÃ y</th>
                      <th>ğŸ’– YÃªu thÃ­ch</th>
                      <th>ğŸ¯ Thao tÃ¡c</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${data.map((item) => {
                      const safePhoto = item.photo && item.photo.startsWith("data:image/") ? item.photo : null;
                      return `
                        <tr>
                          <td><input type="checkbox" class="checkbox" data-id="${item.id}"></td>
                          <td>${safePhoto 
                            ? `<img src="${safePhoto}" class="table-img" onclick="openModal('${safePhoto}')">`
                            : '<span style="color: #ffb3d9;">ğŸ’­ KhÃ´ng cÃ³ áº£nh</span>'
                          }</td>
                          <td><strong>â­ ${item.rating}</strong></td>
                          <td style="max-width: 300px; text-align: left; color: #666;">${item.feeling}</td>
                          <td style="white-space: nowrap; color: #ff9ec4; font-weight: 600;">${new Date(item.created_at).toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" })}</td>
                          <td>
                            <button class="table-favorite-btn" onclick="toggleFavorite(${item.id}, ${item.is_favorite})">${item.is_favorite ? "ğŸ’–" : "ğŸ¤"}</button>
                          </td>
                          <td>
                            <button class="table-delete-btn" onclick="deleteRating(${item.id})">ğŸ—‘ï¸ XÃ³a</button>
                          </td>
                        </tr>`;
                    }).join("")}
                  </tbody>
                </table>`;
            } else {
              container.className = "container grid-view";
              container.innerHTML = data.map((item) => {
                const safePhoto = item.photo && item.photo.startsWith("data:image/") ? item.photo : null;
                return `
                  <div class="memory-item">
                    <div class="memory-item-header">
                      <input type="checkbox" class="checkbox" data-id="${item.id}">
                      <span class="rating-badge">â­ ${item.rating} sao</span>
                    </div>
                    <span class="date-badge">ğŸ“… ${new Date(item.created_at).toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" })}</span>
                    <div class="feeling-text">ğŸ’­ ${item.feeling}</div>
                    ${safePhoto 
                      ? `<img src="${safePhoto}" onclick="openModal('${safePhoto}')" alt="Memory photo">`
                      : '<div class="no-image">ğŸ“· ChÆ°a cÃ³ áº£nh ká»· niá»‡m</div>'
                    }
                    <div class="button-group">
                      <button class="favorite-btn" onclick="toggleFavorite(${item.id}, ${item.is_favorite})">${item.is_favorite ? "ğŸ’– ÄÃ£ yÃªu thÃ­ch rá»“i nÃ¨" : "ğŸ¤ ThÃªm vÃ o yÃªu thÃ­ch"}</button>
                      <button class="delete-btn" onclick="deleteRating(${item.id})">ğŸ—‘ï¸ XÃ³a Ä‘i</button>
                    </div>
                  </div>`;
              }).join("");
            }
          })
          .catch(err => {
            console.error('Error:', err);
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ˜¢</div>
                <div class="empty-state-text">Ã”i khÃ´ng! KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u Ä‘Æ°á»£c ğŸ’”</div>
              </div>
            `;
          });
      }

      function deleteRating(id) {
        if (confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a ká»· niá»‡m nÃ y khÃ´ng? ğŸ¥º")) {
          fetch(`${API_URL}/api/ratings/${id}`, { method: "DELETE" })
            .then(() => fetchRatings());
        }
      }

      function deleteSelectedRatings() {
        const checkboxes = document.querySelectorAll(".checkbox:checked");
        if (!checkboxes.length) {
          alert("ChÆ°a chá»n ká»· niá»‡m nÃ o Ä‘á»ƒ xÃ³a cáº£~ ğŸ’•");
          return;
        }
        if (!confirm(`Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a ${checkboxes.length} ká»· niá»‡m Ä‘Ã£ chá»n khÃ´ng? ğŸ¥ºğŸ’”`)) return;
        
        const ids = Array.from(checkboxes).map((cb) => cb.dataset.id);
        Promise.all(ids.map((id) => fetch(`${API_URL}/api/ratings/${id}`, { method: "DELETE" })))
          .then(() => fetchRatings());
      }

      function toggleFavorite(id, current) {
        fetch(`${API_URL}/api/ratings/${id}/favorite`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ is_favorite: !current }),
        }).then(() => fetchRatings());
      }

      function toggleViewMode() {
        isListView = !isListView;
        document.querySelector(".toggle-view-btn").textContent = isListView
          ? "ğŸ”„ Chuyá»ƒn sang lÆ°á»›i"
          : "ğŸ”„ Chuyá»ƒn sang báº£ng";
        fetchRatings();
      }

      function openModal(src) {
        const modal = document.getElementById("imgModal");
        const img = document.getElementById("modalImg");
        const link = document.getElementById("downloadLink");
        modal.style.display = "block";
        img.src = src;
        link.href = src;
      }

      function closeModal() {
        document.getElementById("imgModal").style.display = "none";
      }

      window.onclick = function(event) {
        const modal = document.getElementById("imgModal");
        if (event.target == modal) {
          closeModal();
        }
      }

      fetchRatings();
    </script>
  </body>
</html>